context("Machine Learning SVM Regression")

options <- initMlOptions("mlRegressionSvm")
options$target <- "Sepal.Length"
options$predictors <- c("Sepal.Width", "Petal.Length", "Petal.Width")
options$validationMeasures <- TRUE
options$supportVectorsTable <- TRUE
options$predictedPerformancePlot <- TRUE
options$modelOptimization <- "manual"
options$addIndicator <- FALSE
options$addPredictions <- FALSE
options$holdoutData <- "holdoutManual"
options$modelValid <- "validationManual"
options$noOfFolds <- 5
options$predictionsColumn <- ""
options$saveModel <- FALSE
options$savePath <- ""
options$setSeed <- TRUE
options$testDataManual <- 0.2
options$testIndicatorColumn <- ""
options$testSetIndicatorVariable <- ""
options$validationDataManual <- 0.2
options$tableShap <- TRUE
options$fromIndex <- 1
options$toIndex <- 5
options$featureImportanceTable <- TRUE
set.seed(1)
results <- jaspTools::runAnalysis("mlRegressionSvm", "iris.csv", options)


test_that("Data Split plot matches", {
	plotName <- results[["results"]][["plotDataSplit"]][["data"]]
	testPlot <- results[["state"]][["figures"]][[plotName]][["obj"]]
	jaspTools::expect_equal_plots(testPlot, "data-split")
})

test_that("Predictive Performance Plot matches", {
	plotName <- results[["results"]][["predictedPerformancePlot"]][["data"]]
	testPlot <- results[["state"]][["figures"]][[plotName]][["obj"]]
	jaspTools::expect_equal_plots(testPlot, "predictive-performance-plot")
})

test_that("Support Vector Machine Regression table results match", {
	table <- results[["results"]][["regressionTable"]][["data"]]
	jaspTools::expect_equal_tables(table,
		list(1, 30, 120, 0.082058421211194, 117))
})

test_that("Support Vectors table results match", {
	table <- results[["results"]][["supportVectorsTable"]][["data"]]
	jaspTools::expect_equal_tables(table,
		list(-1.27910398223806, -1.31105214820513, 0.786173830160854, 1, 0.42032557786565,
			 0.132067294448948, -0.590395133155819, 2, 0.42032557786565,
			 0.394452647658781, -0.131538812050262, 3, 0.760211489886394,
			 0.394452647658781, -0.590395133155819, 4, -1.22245633023461,
			 -1.31105214820513, 0.327317509055296, 5, 1.32668800992096, 0.919223354078446,
			 -0.590395133155819, 6, 1.04344974990368, 1.57518673710303, 0.786173830160854,
			 7, 0.250382621855279, 0.132067294448948, -0.819823293708598,
			 8, 0.137087317848365, 0.132067294448948, -1.27867961481416,
			 9, -1.33575163424152, -1.31105214820513, -0.36096697260304,
			 10, -1.33575163424152, -1.31105214820513, 0.786173830160854,
			 11, -1.05251337422423, -1.31105214820513, 0.786173830160854,
			 12, 0.760211489886394, 0.919223354078446, -0.819823293708598,
			 13, 0.646916185879479, 0.394452647658781, 0.0978893485025173,
			 14, 1.15674505391059, 1.3128013838932, -0.131538812050262, 15,
			 0.193734969851822, -0.261510735365801, -0.819823293708598, 16,
			 0.250382621855279, 0.132067294448948, -0.36096697260304, 17,
			 1.49663096593134, 1.05041603068336, 1.70388647237197, 18, 0.533620881872565,
			 0.263259971053865, 0.327317509055296, 19, 0.760211489886394,
			 0.919223354078446, -0.819823293708598, 20, 0.646916185879479,
			 1.05041603068336, -0.590395133155819, 21, -1.27910398223806,
			 -1.31105214820513, 1.01560199071363, 22, 0.760211489886394,
			 0.525645324263697, -0.819823293708598, 23, -1.27910398223806,
			 -1.0486667949953, 3.08045543568864, 24, -1.33575163424152, -1.31105214820513,
			 2.62159911458308, 25, -1.27910398223806, -1.31105214820513,
			 1.47445831181919, 26, -1.33575163424152, -1.31105214820513,
			 -0.131538812050262, 27, -1.33575163424152, -1.31105214820513,
			 0.327317509055296, 28, 0.42032557786565, 0.656838000868614,
			 -1.27867961481416, 29, -1.39239928624498, -1.17985947160021,
			 -1.73753593591971, 30, -0.259446246175835, -0.261510735365801,
			 -1.50810777536693, 31, 0.137087317848365, 0.132067294448948,
			 -0.590395133155819, 32, 0.476973229869108, 0.132067294448948,
			 -0.36096697260304, 33, -1.27910398223806, -1.0486667949953,
			 1.47445831181919, 34, 0.250382621855279, 0.000874617844032097,
			 -0.131538812050262, 35, 0.590268533876022, 0.263259971053865,
			 -0.590395133155819, 36, 0.363677925862193, 0.000874617844032097,
			 -1.04925145426138, 37, -1.33575163424152, -1.44224482481005,
			 -0.131538812050262, 38, -0.0328556381620065, -0.261510735365801,
			 -1.50810777536693, 39, -1.33575163424152, -1.17985947160021,
			 -0.131538812050262, 40, 0.703563837882936, 1.05041603068336,
			 -1.27867961481416, 41, 0.590268533876022, 0.78803067747353,
			 0.327317509055296, 42, 0.81685914188985, 1.05041603068336, -0.131538812050262,
			 43, 0.0804396658449078, 0.263259971053865, -0.819823293708598,
			 44, 0.533620881872565, 0.525645324263697, 0.556745669608075,
			 45, 0.0804396658449078, 0.000874617844032097, -0.819823293708598,
			 46, -1.39239928624498, -1.31105214820513, 0.327317509055296,
			 47, -1.33575163424152, -1.31105214820513, 0.556745669608075,
			 48, 0.307030273858736, 0.132067294448948, -0.36096697260304,
			 49, 0.0804396658449078, -0.130318058760884, -1.27867961481416,
			 50, 1.66657392194171, 1.05041603068336, -0.590395133155819,
			 51, 0.42032557786565, 0.525645324263697, 0.786173830160854,
			 52, -1.39239928624498, -1.31105214820513, 0.327317509055296,
			 53, -1.16580867823115, -0.917474118390382, 0.556745669608075,
			 54, -1.33575163424152, -1.17985947160021, 0.786173830160854,
			 55, -1.27910398223806, -1.44224482481005, 0.0978893485025173,
			 56, 0.81685914188985, 1.44399406049811, -0.131538812050262,
			 57, 1.10009740190714, 1.18160870728828, 0.556745669608075, 58,
			 -0.146150942168921, -0.261510735365801, -2.42582041757805, 59,
			 -1.33575163424152, -1.44224482481005, 1.24503015126641, 60,
			 1.32668800992096, 1.44399406049811, -0.131538812050262, 61,
			 -1.39239928624498, -1.17985947160021, 1.01560199071363, 63,
			 0.930154445896765, 1.18160870728828, 0.0978893485025173, 64,
			 0.930154445896765, 1.44399406049811, 0.786173830160854, 65,
			 0.986802097900222, 0.78803067747353, -0.131538812050262, 66,
			 0.363677925862193, 0.132067294448948, -1.73753593591971, 67,
			 0.533620881872565, 0.263259971053865, -0.36096697260304, 68,
			 0.873506793893308, 1.44399406049811, 0.327317509055296, 69,
			 1.15674505391059, 0.78803067747353, -1.27867961481416, 70, 1.04344974990368,
			 1.18160870728828, -0.590395133155819, 71, 0.42032557786565,
			 0.394452647658781, -0.131538812050262, 72, -0.146150942168921,
			 -0.261510735365801, -1.04925145426138, 73, -1.22245633023461,
			 -1.31105214820513, -0.131538812050262, 74, -1.39239928624498,
			 -1.31105214820513, 1.01560199071363, 75, 0.42032557786565, 0.394452647658781,
			 -0.36096697260304, 76, 0.760211489886394, 1.44399406049811,
			 0.0978893485025173, 77, 0.533620881872565, 0.394452647658781,
			 0.0978893485025173, 78, -0.429389202186207, -0.130318058760884,
			 -1.27867961481416, 79, 0.42032557786565, 0.394452647658781,
			 -1.96696409647249, 80, -1.22245633023461, -1.31105214820513,
			 0.0978893485025173, 81, 1.21339270591405, 1.18160870728828,
			 -0.131538812050262, 82, 0.703563837882936, 0.656838000868614,
			 -0.131538812050262, 83, 1.43998331392788, 0.78803067747353,
			 -0.36096697260304, 84, -1.50569459025189, -1.44224482481005,
			 -0.131538812050262, 86, 0.760211489886394, 1.05041603068336,
			 0.327317509055296, 87, -1.27910398223806, -1.31105214820513,
			 0.786173830160854, 88, 0.590268533876022, 0.78803067747353,
			 -0.590395133155819, 89, 1.04344974990368, 1.57518673710303,
			 0.0978893485025173, 90, -1.44904693824843, -1.31105214820513,
			 2.16274279347753, 91, -1.27910398223806, -1.31105214820513,
			 0.0978893485025173, 92, 1.32668800992096, 1.70637941370794,
			 1.24503015126641, 93, 0.363677925862193, 0.263259971053865,
			 0.0978893485025173, 94, -1.22245633023461, -0.786281441785466,
			 1.01560199071363, 95, 1.77986922594862, 1.44399406049811, -1.04925145426138,
			 96, 0.590268533876022, 0.78803067747353, -0.131538812050262,
			 97, 1.10009740190714, 1.70637941370794, 0.556745669608075, 98,
			 0.307030273858736, 0.132067294448948, -0.36096697260304, 99,
			 1.27004035791751, 1.70637941370794, 0.556745669608075, 100,
			 -1.27910398223806, -1.44224482481005, 2.39217095403031, 101,
			 -1.33575163424152, -1.17985947160021, 1.01560199071363, 102,
			 0.986802097900222, 1.18160870728828, -0.131538812050262, 103,
			 -1.22245633023461, -1.31105214820513, 1.70388647237197, 104,
			 -0.259446246175835, -0.261510735365801, -1.73753593591971, 105,
			 0.986802097900222, 0.78803067747353, 0.0978893485025173, 106,
			 -1.16580867823115, -1.31105214820513, 0.786173830160854, 108,
			 -1.39239928624498, -1.31105214820513, -0.131538812050262, 109,
			 0.137087317848365, 0.132067294448948, -1.73753593591971, 110,
			 0.760211489886394, 0.78803067747353, -0.131538812050262, 111,
			 0.646916185879479, 0.394452647658781, -1.27867961481416, 112,
			 -0.0895032901654637, 0.132067294448948, -0.36096697260304, 113,
			 0.250382621855279, 0.394452647658781, -0.131538812050262, 114,
			 0.476973229869108, 0.394452647658781, -0.590395133155819, 115,
			 -1.33575163424152, -1.31105214820513, 1.01560199071363, 116,
			 0.646916185879479, 0.78803067747353, -0.131538812050262, 117,
			 1.66657392194171, 1.3128013838932, 1.70388647237197, 118, 1.15674505391059,
			 0.525645324263697, -0.131538812050262, 119, -1.27910398223806,
			 -1.17985947160021, 1.70388647237197, 120))
})

test_that("Model Performance Metrics table results match", {
	table <- results[["results"]][["validationMeasures"]][["data"]]
	jaspTools::expect_equal_tables(table,
		list("MSE", 0.082, "RMSE", 0.286, "MAE / MAD", 0.239, "MAPE", "4.13%",
			 "R<unicode>", 0.85))
})

test_that("Additive Explanations for Predictions of Test Set Cases table results match", {
	table <- results[["results"]][["tableShap"]][["data"]]
	jaspTools::expect_equal_tables(table,
		list(-1.70284732609164, 0.579458940805965, 0.372026723752604, 5.85139884742518,
			 1, 5.1000371858921, -1.62997226220754, 0.579458940805963, 0.440393043584613,
			 5.85139884742518, 2, 5.24127856960823, -1.55709719832345, 0.57945894080596,
			 0.235294084088564, 5.85139884742518, 3, 5.10905467399625, -1.77572238997573,
			 0.463082249765419, 0.577125683248692, 5.85139884742518, 4, 5.11588439046356,
			 -1.48422213443936, 0.521270595285695, 0.508759363416681, 5.85139884742518,
			 5, 5.3972066716882))
})

test_that("Feature Importance Metrics table results match", {
	table <- results[["results"]][["featureImportanceTable"]][["data"]]
	jaspTools::expect_equal_tables(table,
		list(1.82736197354532, "Petal.Length", 0.699525438220986, "Petal.Width",
			 0.51979767511543, "Sepal.Width"))
})
