context("Machine Learning SVM Regression")

options <- jaspTools::analysisOptions("mlRegressionSvm")
options$target <- "Sepal.Length"
options$predictors <- c("Sepal.Width", "Petal.Length", "Petal.Width")
options$validationMeasures <- TRUE
options$supportVectorsTable <- TRUE
options$predictedPerformancePlot <- TRUE
options$modelOptimization <- "manual"
options$addIndicator <- FALSE
options$addPredictions <- FALSE
options$holdoutData <- "holdoutManual"
options$modelValid <- "validationManual"
options$noOfFolds <- 5
options$predictionsColumn <- ""
options$saveModel <- FALSE
options$savePath <- ""
options$setSeed <- TRUE
options$testDataManual <- 0.2
options$testIndicatorColumn <- ""
options$testSetIndicatorVariable <- ""
options$validationDataManual <- 0.2
options$shapTable <- TRUE
options$shapFrom <- 1 
options$shapTo <- 5
set.seed(1)
results <- jaspTools::runAnalysis("mlRegressionSvm", "iris.csv", options)


test_that("Data Split plot matches", {
	plotName <- results[["results"]][["plotDataSplit"]][["data"]]
	testPlot <- results[["state"]][["figures"]][[plotName]][["obj"]]
	jaspTools::expect_equal_plots(testPlot, "data-split")
})

test_that("Predictive Performance Plot matches", {
	plotName <- results[["results"]][["predictedPerformancePlot"]][["data"]]
	testPlot <- results[["state"]][["figures"]][[plotName]][["obj"]]
	jaspTools::expect_equal_plots(testPlot, "predictive-performance-plot")
})

test_that("Support Vector Machine Regression table results match", {
	table <- results[["results"]][["regressionTable"]][["data"]]
	jaspTools::expect_equal_tables(table,
		list(120, 30, 0.113927742055951, 117))
})

test_that("Support Vectors table results match", {
	table <- results[["results"]][["supportVectorsTable"]][["data"]]
	jaspTools::expect_equal_tables(table,
		list(-1.27910398223806, -1.31105214820513, 0.786173830160855, 1, 0.420325577865652,
			 0.132067294448949, -0.590395133155817, 2, 0.420325577865652,
			 0.394452647658782, -0.13153881205026, 3, 0.760211489886395,
			 0.394452647658782, -0.590395133155817, 4, -1.2224563302346,
			 -1.31105214820513, 0.327317509055298, 5, 1.32668800992097, 0.919223354078447,
			 -0.590395133155817, 6, 1.04344974990368, 1.57518673710303, 0.786173830160855,
			 7, 0.250382621855281, 0.132067294448949, -0.819823293708595,
			 8, 0.137087317848366, 0.132067294448949, -1.27867961481415,
			 9, -1.33575163424152, -1.31105214820513, -0.360966972603039,
			 10, -1.33575163424152, -1.31105214820513, 0.786173830160855,
			 11, -1.05251337422423, -1.31105214820513, 0.786173830160855,
			 12, 0.760211489886395, 0.919223354078447, -0.819823293708595,
			 13, 0.646916185879481, 0.394452647658782, 0.0978893485025193,
			 14, 1.1567450539106, 1.3128013838932, -0.13153881205026, 15,
			 0.193734969851823, -0.2615107353658, -0.819823293708595, 16,
			 0.250382621855281, 0.132067294448949, -0.360966972603039, 17,
			 1.49663096593134, 1.05041603068336, 1.70388647237197, 18, 0.533620881872567,
			 0.263259971053865, 0.327317509055298, 19, 0.760211489886395,
			 0.919223354078447, -0.819823293708595, 20, 0.646916185879481,
			 1.05041603068336, -0.590395133155817, 21, -1.27910398223806,
			 -1.31105214820513, 1.01560199071363, 22, 0.760211489886395,
			 0.525645324263698, -0.819823293708595, 23, -1.27910398223806,
			 -1.0486667949953, 3.08045543568864, 24, -1.27910398223806, -1.31105214820513,
			 1.47445831181919, 26, -1.33575163424152, -1.31105214820513,
			 -0.13153881205026, 27, -1.33575163424152, -1.31105214820513,
			 0.327317509055298, 28, 0.420325577865652, 0.656838000868614,
			 -1.27867961481415, 29, -1.39239928624498, -1.17985947160021,
			 -1.73753593591971, 30, -0.259446246175834, -0.2615107353658,
			 -1.50810777536693, 31, 0.137087317848366, 0.132067294448949,
			 -0.590395133155817, 32, 0.476973229869109, 0.132067294448949,
			 -0.360966972603039, 33, -1.27910398223806, -1.0486667949953,
			 1.47445831181919, 34, 0.250382621855281, 0.000874617844032679,
			 -0.13153881205026, 35, 0.590268533876024, 0.263259971053865,
			 -0.590395133155817, 36, 0.363677925862195, 0.000874617844032679,
			 -1.04925145426137, 37, -1.33575163424152, -1.44224482481005,
			 -0.13153881205026, 38, -0.032855638162005, -0.2615107353658,
			 -1.50810777536693, 39, -1.33575163424152, -1.17985947160021,
			 -0.13153881205026, 40, 0.703563837882938, 1.05041603068336,
			 -1.27867961481415, 41, 0.590268533876024, 0.788030677473531,
			 0.327317509055298, 42, 0.816859141889852, 1.05041603068336,
			 -0.13153881205026, 43, 0.0804396658449091, 0.263259971053865,
			 -0.819823293708595, 44, 0.533620881872567, 0.525645324263698,
			 0.556745669608076, 45, 0.0804396658449091, 0.000874617844032679,
			 -0.819823293708595, 46, -1.39239928624498, -1.31105214820513,
			 0.327317509055298, 47, -1.33575163424152, -1.31105214820513,
			 0.556745669608076, 48, 0.307030273858738, 0.132067294448949,
			 -0.360966972603039, 49, 0.0804396658449091, -0.130318058760884,
			 -1.27867961481415, 50, 1.66657392194171, 1.05041603068336, -0.590395133155817,
			 51, 0.420325577865652, 0.525645324263698, 0.786173830160855,
			 52, -1.39239928624498, -1.31105214820513, 0.327317509055298,
			 53, -1.16580867823115, -0.917474118390381, 0.556745669608076,
			 54, -1.33575163424152, -1.17985947160021, 0.786173830160855,
			 55, -1.27910398223806, -1.44224482481005, 0.0978893485025193,
			 56, 0.816859141889852, 1.44399406049811, -0.13153881205026,
			 57, 1.10009740190714, 1.18160870728828, 0.556745669608076, 58,
			 -0.146150942168919, -0.2615107353658, -2.42582041757805, 59,
			 -1.33575163424152, -1.44224482481005, 1.24503015126641, 60,
			 1.32668800992097, 1.44399406049811, -0.13153881205026, 61, -1.39239928624498,
			 -1.17985947160021, 1.01560199071363, 63, 0.930154445896767,
			 1.18160870728828, 0.0978893485025193, 64, 0.930154445896767,
			 1.44399406049811, 0.786173830160855, 65, 0.986802097900224,
			 0.788030677473531, -0.13153881205026, 66, 0.363677925862195,
			 0.132067294448949, -1.73753593591971, 67, 0.533620881872567,
			 0.263259971053865, -0.360966972603039, 68, 0.873506793893309,
			 1.44399406049811, 0.327317509055298, 69, 1.1567450539106, 0.788030677473531,
			 -1.27867961481415, 70, 1.04344974990368, 1.18160870728828, -0.590395133155817,
			 71, 0.420325577865652, 0.394452647658782, -0.13153881205026,
			 72, -0.146150942168919, -0.2615107353658, -1.04925145426137,
			 73, -1.2224563302346, -1.31105214820513, -0.13153881205026,
			 74, -1.39239928624498, -1.31105214820513, 1.01560199071363,
			 75, 0.420325577865652, 0.394452647658782, -0.360966972603039,
			 76, 0.760211489886395, 1.44399406049811, 0.0978893485025193,
			 77, 0.533620881872567, 0.394452647658782, 0.0978893485025193,
			 78, -0.429389202186205, -0.130318058760884, -1.27867961481415,
			 79, 0.420325577865652, 0.394452647658782, -1.96696409647249,
			 80, -1.2224563302346, -1.31105214820513, 0.0978893485025193,
			 81, 1.21339270591405, 1.18160870728828, -0.13153881205026, 82,
			 0.703563837882938, 0.656838000868614, -0.13153881205026, 83,
			 1.43998331392788, 0.788030677473531, -0.360966972603039, 84,
			 -1.50569459025189, -1.44224482481005, -0.13153881205026, 86,
			 0.760211489886395, 1.05041603068336, 0.327317509055298, 87,
			 -1.27910398223806, -1.31105214820513, 0.786173830160855, 88,
			 0.590268533876024, 0.788030677473531, -0.590395133155817, 89,
			 1.04344974990368, 1.57518673710303, 0.0978893485025193, 90,
			 -1.44904693824843, -1.31105214820513, 2.16274279347753, 91,
			 -1.27910398223806, -1.31105214820513, 0.0978893485025193, 92,
			 1.32668800992097, 1.70637941370795, 1.24503015126641, 93, 0.363677925862195,
			 0.263259971053865, 0.0978893485025193, 94, -1.2224563302346,
			 -0.786281441785465, 1.01560199071363, 95, 1.77986922594862,
			 1.44399406049811, -1.04925145426137, 96, 0.590268533876024,
			 0.788030677473531, -0.13153881205026, 97, 1.10009740190714,
			 1.70637941370795, 0.556745669608076, 98, 0.307030273858738,
			 0.132067294448949, -0.360966972603039, 99, 1.27004035791751,
			 1.70637941370795, 0.556745669608076, 100, -1.27910398223806,
			 -1.44224482481005, 2.39217095403031, 101, -1.33575163424152,
			 -1.17985947160021, 1.01560199071363, 102, 0.986802097900224,
			 1.18160870728828, -0.13153881205026, 103, -1.2224563302346,
			 -1.31105214820513, 1.70388647237197, 104, -0.259446246175834,
			 -0.2615107353658, -1.73753593591971, 105, 0.986802097900224,
			 0.788030677473531, 0.0978893485025193, 106, -1.16580867823115,
			 -1.0486667949953, 1.93331463292475, 107, -1.16580867823115,
			 -1.31105214820513, 0.786173830160855, 108, -1.39239928624498,
			 -1.31105214820513, -0.13153881205026, 109, 0.137087317848366,
			 0.132067294448949, -1.73753593591971, 110, 0.760211489886395,
			 0.788030677473531, -0.13153881205026, 111, 0.646916185879481,
			 0.394452647658782, -1.27867961481415, 112, -0.0895032901654623,
			 0.132067294448949, -0.360966972603039, 113, 0.250382621855281,
			 0.394452647658782, -0.13153881205026, 114, 0.476973229869109,
			 0.394452647658782, -0.590395133155817, 115, -1.33575163424152,
			 -1.31105214820513, 1.01560199071363, 116, 0.646916185879481,
			 0.788030677473531, -0.13153881205026, 117, 1.66657392194171,
			 1.3128013838932, 1.70388647237197, 118, 1.1567450539106, 0.525645324263698,
			 -0.13153881205026, 119, -1.27910398223806, -1.17985947160021,
			 1.70388647237197, 120))
})

test_that("Evaluation Metrics table results match", {
	table <- results[["results"]][["validationMeasures"]][["data"]]
	jaspTools::expect_equal_tables(table,
		list("MSE", 0.114, "RMSE", 0.338, "MAE / MAD", 0.284, "MAPE", "84.57%", "R<unicode><unicode>",
			 0.853))
})

test_that("Feature Contributions to Predictions for Test Set Cases table results match", {
	table <- results[["results"]][["shapTable"]][["data"]]
	jaspTools::expect_equal_tables(table,
		list(0.446246397209695, 0.0753544365869729, 0.0423939026885956, 0.0837312232013308,
			 0.330060685696838, 1, "setosa (0.978)", 0.0672463699932125,
			 0.441679193107275, 0.0319684379167983, 0.099093407572473, 0.330060685696838,
			 2, "setosa (0.97)", 0.059125021366628, 0.436356111717586, 0.117028543753257,
			 0.0268778017523981, 0.330060685696838, 3, "setosa (0.969)",
			 0.431594401877119, 0.0379631581356391, 0.0313367184581614, 0.13907234618323,
			 0.330060685696838, 4, "setosa (0.97)", 0.0513011440533579, 0.392950061066032,
			 0.0281980422852209, 0.143787804073311, 0.330060685696838, 5,
			 "setosa (0.946)"))
})
