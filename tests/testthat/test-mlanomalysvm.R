context("Machine Learning Isolation Forest Anomaly Detection")

options <- analysisOptions("mlAnomalySvm")
options$predictors <- c("Sepal.Length", "Sepal.Width", "Petal.Length", "Petal.Width")
options$tableAnomalyScores <- TRUE
options$tableAnomalyScoresFeatures <- TRUE
options$matrixPlot <- TRUE
options$addPredictions <- FALSE
options$predictionsColumn <- ""
options$saveModel <- FALSE
options$savePath <- ""
options$supportVectors <- TRUE
set.seed(1)
results <- runAnalysis("mlAnomalySvm", "iris.csv", options)


test_that("Support Vector Machine Anomaly Detection table results match", {
	table <- results[["results"]][["anomalyTable"]][["data"]]
	jaspTools::expect_equal_tables(table,
		list(150, 102, 82))
})

test_that("Anomaly Matrix Plot matches", {
	plotName <- results[["results"]][["matrixPlot"]][["data"]]
	testPlot <- results[["state"]][["figures"]][[plotName]][["obj"]]
	jaspTools::expect_equal_plots(testPlot, "anomaly-matrix-plot")
})

test_that("Detected Anomalies table results match", {
	table <- results[["results"]][["tableAnomalyScores"]][["data"]]
	jaspTools::expect_equal_tables(table,
		list(-1.33575163424152, -1.31105214820513, -0.897673879196767, 1.01560199071363,
			 "Anomaly", 1, -1.33575163424152, -1.31105214820513, -1.13920048346495,
			 -0.131538812050262, "Anomaly", 2, -1.39239928624498, -1.31105214820513,
			 -1.38072708773314, 0.327317509055296, "Anomaly", 3, -1.27910398223806,
			 -1.31105214820513, -1.50149038986724, 0.0978893485025174, "Anomaly",
			 4, -1.33575163424152, -1.31105214820513, -1.01843718133086,
			 1.24503015126641, "Anomaly", 5, -1.16580867823115, -1.0486667949953,
			 -0.535383972794484, 1.93331463292475, "Anomaly", 6, -1.33575163424152,
			 -1.17985947160021, -1.50149038986724, 0.786173830160854, "Anomaly",
			 7, -1.27910398223806, -1.31105214820513, -1.01843718133086,
			 0.786173830160854, "Anomaly", 8, -1.33575163424152, -1.31105214820513,
			 -1.74301699413542, -0.360966972603041, "Anomaly", 9, -1.27910398223806,
			 -1.44224482481005, -1.13920048346495, 0.0978893485025174, "Anomaly",
			 10, -1.27910398223806, -1.31105214820513, -0.535383972794484,
			 1.47445831181919, "Anomaly", 11, -1.22245633023461, -1.31105214820513,
			 -1.25996378559905, 0.786173830160854, "Anomaly", 12, -1.33575163424152,
			 -1.44224482481005, -1.25996378559905, -0.131538812050262, "Anomaly",
			 13, -1.50569459025189, -1.44224482481005, -1.86378029626952,
			 -0.131538812050262, "Anomaly", 14, -1.44904693824844, -1.31105214820513,
			 -0.0523307642581091, 2.16274279347753, "Anomaly", 15, -1.27910398223806,
			 -1.0486667949953, -0.173094066392203, 3.08045543568864, "Anomaly",
			 16, -1.39239928624498, -1.0486667949953, -0.535383972794484,
			 1.93331463292475, "Anomaly", 17, -1.33575163424152, -1.17985947160021,
			 -0.897673879196767, 1.01560199071363, "Anomaly", 18, -1.16580867823115,
			 -1.17985947160021, -0.173094066392203, 1.70388647237197, "Anomaly",
			 19, -1.27910398223806, -1.17985947160021, -0.897673879196767,
			 1.70388647237197, "Anomaly", 20, -1.16580867823115, -1.31105214820513,
			 -0.535383972794484, 0.786173830160854, "Anomaly", 21, -1.27910398223806,
			 -1.0486667949953, -0.897673879196767, 1.47445831181919, "Anomaly",
			 22, -1.56234224225535, -1.31105214820513, -1.50149038986724,
			 1.24503015126641, "Anomaly", 23, -1.16580867823115, -0.917474118390382,
			 -0.897673879196767, 0.556745669608074, "Anomaly", 24, -1.05251337422424,
			 -1.31105214820513, -1.25996378559905, 0.786173830160854, "Anomaly",
			 25, -1.22245633023461, -1.31105214820513, -1.01843718133086,
			 -0.131538812050262, "Anomaly", 26, -1.22245633023461, -1.0486667949953,
			 -1.01843718133086, 0.786173830160854, "Anomaly", 27, -1.27910398223806,
			 -1.31105214820513, -0.776910577062673, 1.01560199071363, "Anomaly",
			 28, -1.33575163424152, -1.31105214820513, -0.776910577062673,
			 0.786173830160854, "Anomaly", 29, -1.22245633023461, -1.31105214820513,
			 -1.38072708773314, 0.327317509055296, "Anomaly", 30, -1.22245633023461,
			 -1.31105214820513, -1.25996378559905, 0.0978893485025174, "Anomaly",
			 31, -1.27910398223806, -1.0486667949953, -0.535383972794484,
			 0.786173830160854, "Anomaly", 32, -1.27910398223806, -1.44224482481005,
			 -0.776910577062673, 2.3921709540303, "Anomaly", 33, -1.33575163424152,
			 -1.31105214820513, -0.414620670660391, 2.62159911458309, "Anomaly",
			 34, -1.27910398223806, -1.31105214820513, -1.13920048346495,
			 0.0978893485025174, "Anomaly", 35, -1.44904693824844, -1.31105214820513,
			 -1.01843718133086, 0.327317509055296, "Anomaly", 36, -1.39239928624498,
			 -1.31105214820513, -0.414620670660391, 1.01560199071363, "Anomaly",
			 37, -1.33575163424152, -1.44224482481005, -1.13920048346495,
			 1.24503015126641, "Anomaly", 38, -1.39239928624498, -1.31105214820513,
			 -1.74301699413542, -0.131538812050262, "Anomaly", 39, -1.27910398223806,
			 -1.31105214820513, -0.897673879196767, 0.786173830160854, "Anomaly",
			 40, -1.39239928624498, -1.17985947160021, -1.01843718133086,
			 1.01560199071363, "Anomaly", 41, -1.39239928624498, -1.17985947160021,
			 -1.62225369200133, -1.73753593591971, "Anomaly", 42, -1.39239928624498,
			 -1.31105214820513, -1.74301699413542, 0.327317509055296, "Anomaly",
			 43, -1.22245633023461, -0.786281441785466, -1.01843718133086,
			 1.01560199071363, "Anomaly", 44, -1.05251337422424, -1.0486667949953,
			 -0.897673879196767, 1.70388647237197, "Anomaly", 45, -1.33575163424152,
			 -1.17985947160021, -1.25996378559905, -0.131538812050262, "Anomaly",
			 46, -1.22245633023461, -1.31105214820513, -0.897673879196767,
			 1.70388647237197, "Anomaly", 47, -1.33575163424152, -1.31105214820513,
			 -1.50149038986724, 0.327317509055296, "Anomaly", 48, -1.27910398223806,
			 -1.31105214820513, -0.656147274928579, 1.47445831181919, "Anomaly",
			 49, -1.33575163424152, -1.31105214820513, -1.01843718133086,
			 0.556745669608074, "Anomaly", 50, 0.420325577865651, 0.394452647658781,
			 0.672249048546455, 0.327317509055296, "Anomaly", 52, 0.137087317848365,
			 0.132067294448948, -0.414620670660391, -1.73753593591971, "Anomaly",
			 54, 0.420325577865651, 0.132067294448948, -0.173094066392203,
			 -0.59039513315582, "Anomaly", 56, 0.533620881872565, 0.525645324263697,
			 0.551485746412361, 0.556745669608074, "Anomaly", 57, -0.259446246175835,
			 -0.261510735365801, -1.13920048346495, -1.50810777536693, "Anomaly",
			 58, 0.0804396658449076, 0.263259971053864, -0.776910577062673,
			 -0.819823293708598, "Anomaly", 60, -0.146150942168921, -0.261510735365801,
			 -1.01843718133086, -2.42582041757805, "Anomaly", 61, 0.250382621855279,
			 0.394452647658781, 0.0684325378759855, -0.131538812050262, "Anomaly",
			 62, 0.533620881872565, 0.263259971053864, 0.309959142144173,
			 -0.360966972603041, "Anomaly", 64, -0.0895032901654638, 0.132067294448948,
			 -0.293857368526297, -0.360966972603041, "Anomaly", 65, 0.420325577865651,
			 0.394452647658781, -0.293857368526297, -0.131538812050262, "Anomaly",
			 67, 0.193734969851822, -0.261510735365801, -0.0523307642581091,
			 -0.819823293708598, "Anomaly", 68, 0.0804396658449076, -0.130318058760884,
			 -0.293857368526297, -1.27867961481416, "Anomaly", 70, 0.590268533876022,
			 0.78803067747353, 0.0684325378759855, 0.327317509055296, "Anomaly",
			 71, 0.533620881872565, 0.000874617844031805, 0.309959142144173,
			 -0.59039513315582, "Anomaly", 74, 0.420325577865651, 0.394452647658781,
			 0.189195840010079, -0.360966972603041, "Anomaly", 79, -0.146150942168921,
			 -0.261510735365801, -0.173094066392203, -1.04925145426138, "Anomaly",
			 80, 0.0237920138414504, -0.130318058760884, -0.414620670660391,
			 -1.50810777536693, "Anomaly", 81, -0.0328556381620066, -0.261510735365801,
			 -0.414620670660391, -1.50810777536693, "Anomaly", 82, 0.0804396658449076,
			 0.000874617844031805, -0.0523307642581091, -0.819823293708598,
			 "Anomaly", 83, 0.760211489886393, 0.525645324263697, 0.189195840010079,
			 -0.819823293708598, "Anomaly", 84, 0.420325577865651, 0.394452647658781,
			 -0.535383972794484, -0.131538812050262, "Anomaly", 85, 0.420325577865651,
			 0.525645324263697, 0.189195840010079, 0.786173830160854, "Anomaly",
			 86, 0.193734969851822, 0.132067294448948, -0.293857368526297,
			 -0.131538812050262, "Anomaly", 89, 0.137087317848365, 0.132067294448948,
			 -0.414620670660391, -1.27867961481416, "Anomaly", 90, 0.363677925862194,
			 0.000874617844031805, -0.414620670660391, -1.04925145426138,
			 "Anomaly", 91, 0.476973229869108, 0.263259971053864, 0.309959142144173,
			 -0.131538812050262, "Anomaly", 92, 0.137087317848365, 0.000874617844031805,
			 -0.0523307642581091, -1.04925145426138, "Anomaly", 93, -0.259446246175835,
			 -0.261510735365801, -1.01843718133086, -1.73753593591971, "Anomaly",
			 94, 0.250382621855279, 0.132067294448948, -0.293857368526297,
			 -0.819823293708598, "Anomaly", 95, 0.250382621855279, 0.000874617844031805,
			 -0.173094066392203, -0.131538812050262, "Anomaly", 96, 0.250382621855279,
			 0.132067294448948, -0.173094066392203, -0.360966972603041, "Anomaly",
			 97, -0.429389202186207, -0.130318058760884, -0.897673879196767,
			 -1.27867961481416, "Anomaly", 99, 0.193734969851822, 0.132067294448948,
			 -0.173094066392203, -0.59039513315582, "Anomaly", 100, 1.27004035791751,
			 1.70637941370794, 0.551485746412361, 0.556745669608074, "Anomaly",
			 101, 0.760211489886393, 0.919223354078446, -0.0523307642581091,
			 -0.819823293708598, "Anomaly", 102, 1.04344974990368, 0.78803067747353,
			 0.551485746412361, -0.360966972603041, "Anomaly", 104, 0.420325577865651,
			 0.656838000868613, -1.13920048346495, -1.27867961481416, "Anomaly",
			 107, 0.703563837882936, 1.05041603068336, -0.173094066392203,
			 -1.27867961481416, "Anomaly", 114, 0.760211489886393, 1.57518673710303,
			 -0.0523307642581091, -0.59039513315582, "Anomaly", 115, 0.986802097900222,
			 0.78803067747353, 0.793012350680549, -0.131538812050262, "Anomaly",
			 117, 0.646916185879479, 1.05041603068336, -0.293857368526297,
			 -0.59039513315582, "Anomaly", 122, 1.10009740190714, 1.18160870728828,
			 1.03453895494874, 0.556745669608074, "Anomaly", 125, 0.646916185879479,
			 0.78803067747353, 0.309959142144173, -0.131538812050262, "Anomaly",
			 128, 0.760211489886393, 0.394452647658781, 0.551485746412361,
			 -0.59039513315582, "Anomaly", 134, 1.04344974990368, 0.263259971053864,
			 0.309959142144173, -1.04925145426138, "Anomaly", 135, 1.04344974990368,
			 1.57518673710303, 0.551485746412361, 0.786173830160854, "Anomaly",
			 137, 0.986802097900222, 0.78803067747353, 0.672249048546455,
			 0.0978893485025174, "Anomaly", 138, 0.590268533876022, 0.78803067747353,
			 0.189195840010079, -0.131538812050262, "Anomaly", 139, 0.760211489886393,
			 0.919223354078446, -0.0523307642581091, -0.819823293708598,
			 "Anomaly", 143, 0.930154445896765, 1.44399406049811, 0.430722444278267,
			 0.786173830160854, "Anomaly", 149, 0.760211489886393, 0.78803067747353,
			 0.0684325378759855, -0.131538812050262, "Anomaly", 150))
})