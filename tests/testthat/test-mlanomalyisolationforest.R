context("Machine Learning Isolation Forest Anomaly Detection")

options <- analysisOptions("mlAnomalyIsolationForest")
options$predictors <- c("Sepal.Length", "Sepal.Width", "Petal.Length", "Petal.Width")
options$tableAnomalyScores <- TRUE
options$tableAnomalyScoresFeatures <- TRUE
options$matrixPlot <- TRUE
options$addPredictions <- FALSE
options$predictionsColumn <- ""
options$saveModel <- FALSE
options$savePath <- ""
set.seed(1)
results <- runAnalysis("mlAnomalyIsolationForest", "iris.csv", options)


test_that("Isolation Forest Anomaly Detection table results match", {
	table <- results[["results"]][["anomalyTable"]][["data"]]
	jaspTools::expect_equal_tables(table,
		list(150, 35, 1, 500))
})

test_that("Anomaly Matrix Plot matches", {
	plotName <- results[["results"]][["matrixPlot"]][["data"]]
	testPlot <- results[["state"]][["figures"]][[plotName]][["obj"]]
	jaspTools::expect_equal_plots(testPlot, "anomaly-matrix-plot")
})

test_that("Detected Anomalies table results match", {
	table <- results[["results"]][["tableAnomalyScores"]][["data"]]
	jaspTools::expect_equal_tables(table,
		list(-1.16580867823115, -1.0486667949953, -0.535383972794484, 1.93331463292475,
			 "Anomaly", 6, 0.501270268465414, -1.33575163424152, -1.31105214820513,
			 -1.74301699413542, -0.360966972603041, "Anomaly", 9, 0.510455127728236,
			 -1.50569459025189, -1.44224482481005, -1.86378029626952, -0.131538812050262,
			 "Anomaly", 14, 0.597640497951159, -1.44904693824844, -1.31105214820513,
			 -0.0523307642581091, 2.16274279347753, "Anomaly", 15, 0.580843824994867,
			 -1.27910398223806, -1.0486667949953, -0.173094066392203, 3.08045543568864,
			 "Anomaly", 16, 0.605873404346425, -1.39239928624498, -1.0486667949953,
			 -0.535383972794484, 1.93331463292475, "Anomaly", 17, 0.51773178195675,
			 -1.16580867823115, -1.17985947160021, -0.173094066392203, 1.70388647237197,
			 "Anomaly", 19, 0.524235237489184, -1.56234224225535, -1.31105214820513,
			 -1.50149038986724, 1.24503015126641, "Anomaly", 23, 0.550411883812944,
			 -1.27910398223806, -1.44224482481005, -0.776910577062673, 2.3921709540303,
			 "Anomaly", 33, 0.544038777715029, -1.33575163424152, -1.31105214820513,
			 -0.414620670660391, 2.62159911458309, "Anomaly", 34, 0.53596824487787,
			 -1.39239928624498, -1.17985947160021, -1.62225369200133, -1.73753593591971,
			 "Anomaly", 42, 0.60726769573821, -1.22245633023461, -0.786281441785466,
			 -1.01843718133086, 1.01560199071363, "Anomaly", 44, 0.52005728873189,
			 -1.05251337422424, -1.0486667949953, -0.897673879196767, 1.70388647237197,
			 "Anomaly", 45, 0.519734397934572, -0.259446246175835, -0.261510735365801,
			 -1.13920048346495, -1.50810777536693, "Anomaly", 58, 0.517885814917369,
			 -0.146150942168921, -0.261510735365801, -1.01843718133086, -2.42582041757805,
			 "Anomaly", 61, 0.587742249385345, 0.137087317848365, -0.261510735365801,
			 0.189195840010079, -1.96696409647249, "Anomaly", 63, 0.525553358252765,
			 -0.259446246175835, -0.261510735365801, -1.01843718133086, -1.73753593591971,
			 "Anomaly", 94, 0.513352904652576, -0.429389202186207, -0.130318058760884,
			 -0.897673879196767, -1.27867961481416, "Anomaly", 99, 0.531695376646226,
			 1.27004035791751, 1.70637941370794, 0.551485746412361, 0.556745669608074,
			 "Anomaly", 101, 0.541330708611757, 1.60992626993825, 1.18160870728828,
			 2.12140867415558, -0.131538812050262, "Anomaly", 106, 0.54781430081921,
			 0.420325577865651, 0.656838000868613, -1.13920048346495, -1.27867961481416,
			 "Anomaly", 107, 0.547680825654425, 1.43998331392788, 0.78803067747353,
			 1.7591187677533, -0.360966972603041, "Anomaly", 108, 0.516386989163726,
			 1.15674505391059, 0.78803067747353, 1.03453895494874, -1.27867961481416,
			 "Anomaly", 109, 0.505657698806849, 1.32668800992096, 1.70637941370794,
			 1.63835546561921, 1.24503015126641, "Anomaly", 110, 0.602913543486111,
			 0.760211489886393, 1.57518673710303, -0.0523307642581091, -0.59039513315582,
			 "Anomaly", 115, 0.50984635679143, 1.66657392194171, 1.3128013838932,
			 2.24217197628968, 1.70388647237197, "Anomaly", 118, 0.625060382711781,
			 1.77986922594862, 1.44399406049811, 2.24217197628968, -1.04925145426138,
			 "Anomaly", 119, 0.63983250413119, 0.703563837882936, 0.394452647658781,
			 0.189195840010079, -1.96696409647249, "Anomaly", 120, 0.50033947194607,
			 1.66657392194171, 1.05041603068336, 2.24217197628968, -0.59039513315582,
			 "Anomaly", 123, 0.566984276749151, 1.32668800992096, 0.919223354078446,
			 1.8798820698874, -0.59039513315582, "Anomaly", 131, 0.512932843602584,
			 1.49663096593134, 1.05041603068336, 2.48369858055787, 1.70388647237197,
			 "Anomaly", 132, 0.63925562410004, 1.32668800992096, 1.44399406049811,
			 2.24217197628968, -0.131538812050262, "Anomaly", 136, 0.539533722882549,
			 1.04344974990368, 1.57518673710303, 0.551485746412361, 0.786173830160854,
			 "Anomaly", 137, 0.503357843854786, 1.10009740190714, 1.70637941370794,
			 1.03453895494874, 0.556745669608074, "Anomaly", 145, 0.505204159108136,
			 0.930154445896765, 1.44399406049811, 0.430722444278267, 0.786173830160854,
			 "Anomaly", 149, 0.502934125348414))
})